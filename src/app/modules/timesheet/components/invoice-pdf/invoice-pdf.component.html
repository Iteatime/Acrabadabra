<div class="invoice">
  <div class="invoice__header">
    <div class="invoice__header__provider">
      <div class="invoice__header__provider__name">
        {{ timesheetService.timesheet.invoice.provider.name }}
      </div>
      <div [innerHTML]="timesheetService.timesheet.invoice.provider.getFormattedAddress()"></div>
      <div *ngIf="timesheetService.timesheet.invoice.provider.telephone">
        Tel : {{ timesheetService.timesheet.invoice.provider.getFormattedTelephoneNumber() }}
      </div>
      <div *ngIf="!timesheetService.timesheet.invoice.provider.tradeAndCompaniesRegisterExemption">
        {{ timesheetService.timesheet.invoice.provider.getFormattedSIRENNumber() }} R.C.S.
        {{ timesheetService.timesheet.invoice.provider.tradeAndCompaniesRegisterCity }}
      </div>
      <div *ngIf="timesheetService.timesheet.invoice.provider.tradeAndCompaniesRegisterExemption">
        SIREN : {{ timesheetService.timesheet.invoice.provider.getFormattedSIRENNumber() }}
      </div>
      <div *ngIf="!timesheetService.timesheet.invoice.provider.vatExemption">
        N° TVA intra-communautaire : {{ timesheetService.timesheet.invoice.provider.vatNumber }}
      </div>
      <div *ngIf="timesheetService.timesheet.invoice.provider.tradeAndCompaniesRegisterExemption">
        Dispensé d'immatriculation au registre du commerce et des sociétés (RCS) et au répertoire des métiers (RM)
      </div>
    </div>
    <div class="invoice__header__client">
      <div class="invoice__header__client__name">
        {{ timesheetService.timesheet.invoice.client.name }}
      </div>
      <div [innerHTML]="timesheetService.timesheet.invoice.client.getFormattedAddress()"></div>
      <div *ngIf="timesheetService.timesheet.invoice.client.telephone">
        Tel : {{ timesheetService.timesheet.invoice.client.getFormattedTelephoneNumber() }}
      </div>
      <div *ngIf="!timesheetService.timesheet.invoice.client.tradeAndCompaniesRegisterExemption">
        {{ timesheetService.timesheet.invoice.client.getFormattedSIRENNumber() }} R.C.S.
        {{ timesheetService.timesheet.invoice.client.tradeAndCompaniesRegisterCity }}
      </div>
      <div *ngIf="timesheetService.timesheet.invoice.client.tradeAndCompaniesRegisterExemption">
        SIREN : {{ timesheetService.timesheet.invoice.client.getFormattedSIRENNumber() }}
      </div>
      <div *ngIf="!timesheetService.timesheet.invoice.client.vatExemption">
        N° TVA intra-communautaire : {{ timesheetService.timesheet.invoice.client.vatNumber }}
      </div>
      <div *ngIf="timesheetService.timesheet.invoice.client.tradeAndCompaniesRegisterExemption">
        Dispensé d'immatriculation au registre du commerce et des sociétés (RCS) et au répertoire des métiers (RM)
      </div>
    </div>
  </div>

  <div class="invoice__reference">
    <div class="invoice__reference__number">FACTURE N° {{ timesheetService.timesheet.invoice.number }}</div>
    <div class="invoice__reference__order" *ngIf="timesheetService.timesheet.invoice.clientRef">
      <b>Référence client :</b> {{ timesheetService.timesheet.invoice.clientRef }}
    </div>
    <div class="invoice__reference__date">Date : {{ formatDate(timesheetService.timesheet.invoice.date) }}</div>
  </div>

  <div class="invoice__table">
    <table>
      <thead>
        <th>DESIGNATION DES PRODUITS OU PRESTATIONS</th>
        <th>PRIX UNITAIRE HT</th>
        <th>QUANTITE</th>
        <th *ngIf="!timesheetService.timesheet.invoice.provider.vatExemption">TAUX DE TVA</th>
        <th>TOTAL HT</th>
        <th *ngIf="!timesheetService.timesheet.invoice.provider.vatExemption">TOTAL TTC</th>
      </thead>
      <tbody>
        <tr *ngIf="workedTime > 0">
          <td>Journée d’intervention {{ timesheetService.timesheet.mission.title }}</td>
          <td>{{ timesheetService.timesheet.invoice.dailyRate | currency:currencyCode:"symbol":"1.2-2":local }}</td>
          <td>{{ workedTime }}</td>
          <td *ngIf="!timesheetService.timesheet.invoice.provider.vatExemption">{{ monetaryService.vatRates.normal / 100 | percent:"1.2-2":local }}</td>
          <td>{{ performanceTotal | currency:currencyCode:"symbol":"1.2-2":local }}</td>
          <td *ngIf="!timesheetService.timesheet.invoice.provider.vatExemption">
              {{ performanceTotal * ( 1 + monetaryService.vatRates.normal / 100 ) | currency:currencyCode:"symbol":"1.2-2":local }}</td>
        </tr>

        <tr *ngIf="expenseMileageTotal > 0">
          <td>{{ expenseMileageTitle }}</td>
          <td></td>
          <td>{{ expenseMileageQuantity }}</td>
          <td *ngIf="!timesheetService.timesheet.invoice.provider.vatExemption">{{ monetaryService.vatRates.normal / 100 | percent:"1.2-2":local  }}</td>
          <td>{{ expenseMileageTotal | currency:currencyCode:"symbol":'1.2-2':local }}</td>
          <td *ngIf="!timesheetService.timesheet.invoice.provider.vatExemption">
              {{ expenseMileageTotal * ( 1 + monetaryService.vatRates.normal / 100 ) | currency:currencyCode:"symbol":"1.2-2":local }}</td>
        </tr>

        <tr *ngFor="let value of flatFeesTotal.amounts; let i = index">
          <td>{{ expenseFlatFeeTitle }}</td>
          <td>{{ flatFeesTotal.amounts[i] | currency:currencyCode:"symbol":'1.2-2':local }}</td>
          <td>{{ flatFeesTotal.quantity[i] }}</td>
          <td *ngIf="!timesheetService.timesheet.invoice.provider.vatExemption">{{ monetaryService.vatRates.normal / 100 | percent:"1.2-2":local  }}</td>
          <td> {{ flatFeesTotal.amounts[i] * flatFeesTotal.quantity[i] | currency:currencyCode:"symbol":'1.2-2':local}}</td>
          <td *ngIf="!timesheetService.timesheet.invoice.provider.vatExemption">
              {{ flatFeesTotal.amounts[i]
                * flatFeesTotal.quantity[i]
                * ( 1 + monetaryService.vatRates.normal / 100 ) | currency:currencyCode:"symbol":"1.2-2":local }}</td>
        </tr>

        <tr *ngFor="let miscDeduble of sortByMiscsVatState().deductible">
          <td>Frais sur justificatifs &mdash; deductible</td>
          <td></td>
          <td>{{ miscDeduble.quantity }}</td>
          <td *ngIf="!timesheetService.timesheet.invoice.provider.vatExemption">{{ miscDeduble.vatRate / 100 | percent:"1.2-2":local }}</td>
          <td>{{ miscDeduble.amount / ( 1 + miscDeduble.vatRate / 100) | currency:currencyCode:"symbol":"1.2-2":local }}</td>
          <td *ngIf="!timesheetService.timesheet.invoice.provider.vatExemption">{{ miscDeduble.amount | currency:currencyCode:"symbol":"1.2-2":local }}</td>
        </tr>

        <tr *ngIf="sortByMiscsVatState().nondeductible.amount > 0">
          <td>Frais sur justificatifs</td>
          <td></td>
          <td>{{ sortByMiscsVatState().nondeductible.quantity }}</td>
          <td *ngIf="!timesheetService.timesheet.invoice.provider.vatExemption">{{ monetaryService.vatRates.normal / 100 | percent:"1.2-2":local }}</td>
          <td>{{ sortByMiscsVatState().nondeductible.amount | currency:currencyCode:"symbol":"1.2-2":local }}</td>
          <td *ngIf="!timesheetService.timesheet.invoice.provider.vatExemption">{{ sortByMiscsVatState().nondeductible.amount * (1 + monetaryService.vatRates.normal / 100) | currency:currencyCode:"symbol":"1.2-2":local }}</td>
        </tr>

        <tr *ngIf="(workedTime > 0 ? 1 : 0) + (expenseMileageTotal > 0 ? 1 : 0) + (expenseFlatFeeTotal > 0 ? 1 : 0) + sortByMiscsVatState().deductible.length  + (sortByMiscsVatState().nondeductible.amount > 0 ? 1 : 0) < 2">
          <td></td>
          <td></td>
          <td></td>
          <td *ngIf="!timesheetService.timesheet.invoice.provider.vatExemption"></td>
          <td></td>
          <td *ngIf="!timesheetService.timesheet.invoice.provider.vatExemption"></td>
        </tr>

        <tr *ngIf="(workedTime > 0 ? 1 : 0) + (expenseMileageTotal > 0 ? 1 : 0) + (expenseFlatFeeTotal > 0 ? 1 : 0) + sortByMiscsVatState().deductible.length  + (sortByMiscsVatState().nondeductible.amount > 0 ? 1 : 0) < 3">
          <td></td>
          <td></td>
          <td></td>
          <td *ngIf="!timesheetService.timesheet.invoice.provider.vatExemption"></td>
          <td></td>
          <td *ngIf="!timesheetService.timesheet.invoice.provider.vatExemption"></td>
        </tr>

        <tr *ngIf="(workedTime > 0 ? 1 : 0) + (expenseMileageTotal > 0 ? 1 : 0) + (expenseFlatFeeTotal > 0 ? 1 : 0) + sortByMiscsVatState().deductible.length  + (sortByMiscsVatState().nondeductible.amount > 0 ? 1 : 0) < 4">
          <td></td>
          <td></td>
          <td></td>
          <td *ngIf="!timesheetService.timesheet.invoice.provider.vatExemption"></td>
          <td></td>
          <td *ngIf="!timesheetService.timesheet.invoice.provider.vatExemption"></td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="invoice__total">
    <table>
      <tr>
        <td class="invoice__total__label">
          <p>
            Total HT
          </p>
          <p *ngFor="let vat of totalVat">
            <span>
              Montant TVA {{ vat.rate / 100 | percent:"1.2-2":local }}
            </span>
          </p>
        </td>
        <td></td>
        <td class="invoice__total__value">
          <p>{{ totalHT | currency:currencyCode:"symbol":'1.2-2':local }}</p>
          <p *ngFor="let vat of totalVat">
            <span>
              {{ vat.amount | currency:currencyCode:"symbol":'1.2-2':local }}
            </span>
          </p>
        </td>
      </tr>
      <tr *ngIf="!timesheetService.timesheet.invoice.provider.vatExemption"></tr>
      <tr *ngIf="!timesheetService.timesheet.invoice.provider.vatExemption">
        <td class="invoice__total__label">Total TTC</td>
        <td></td>
        <td class="invoice__total__value">{{ totalTTC | currency:currencyCode:"symbol":'1.2-2':local }}</td>
      </tr>
      <tr *ngIf="timesheetService.timesheet.invoice.provider.vatExemption">
        <td class="invoice__total__no-vat" colspan="3">
          TVA non applicable, art 293 B du CGI
        </td>
      </tr>
    </table>
  </div>

  <div class="invoice__additional-information">
    <div>
      Consultant chargé de la prestation : {{ timesheetService.timesheet.consultant.name }}
    </div>
    <div>
      Date d’exécution de la vente
      <br />
      ou de la prestation : {{ formatDuration() }}
    </div>
    <div>
      Date de règlement : {{ formatDate(timesheetService.timesheet.invoice.paymentDate) }}
    </div>
    <div *ngIf="timesheetService.timesheet.invoice.paymentLatePenalty" id="penalty">
      Tout retard de paiement donnera lieu, en plus des pénalités de retard (10 % par an), au versement d'une indemnité
      forfaitaire de 40€ pour frais de recouvrement.
    </div>
    <div *ngIf="timesheetService.timesheet.invoice.paymentModality">
      Modalités de paiement : {{ timesheetService.timesheet.invoice.paymentModality }}
    </div>
    <div *ngIf="timesheetService.timesheet.invoice.isBankingDetails()">
      <div>Coordonnées bancaires :</div>
      <div>Titulaire du compte : {{ timesheetService.timesheet.invoice.bankAccountHolder }}</div>
      <div>Banque : {{ timesheetService.timesheet.invoice.bankingDomiciliation }}</div>
      <div>Agence : {{ timesheetService.timesheet.invoice.bankingAgency }}</div>
      <div>IBAN : {{ timesheetService.timesheet.invoice.bankIBAN }}</div>
      <div>SWIFT : {{ timesheetService.timesheet.invoice.bankSWIFT }}</div>
    </div>
  </div>

  <div class="invoice__footer">
    <div>
      {{ timesheetService.timesheet.invoice.provider.name }}
      -
      {{ timesheetService.timesheet.invoice.provider.address.replace(';', '') }}
      -
      <span *ngIf="timesheetService.timesheet.invoice.provider.telephone">Tel :{{ timesheetService.timesheet.invoice.provider.getFormattedTelephoneNumber() }} - </span>
      <span *ngIf="!timesheetService.timesheet.invoice.provider.tradeAndCompaniesRegisterExemption">R.C.S.
        {{ timesheetService.timesheet.invoice.provider.tradeAndCompaniesRegisterCity }} </span>
      <span *ngIf="timesheetService.timesheet.invoice.provider.tradeAndCompaniesRegisterExemption">SIREN : </span>
      {{ timesheetService.timesheet.invoice.provider.getFormattedSIRENNumber() }}
    </div>
  </div>
  <div class="invoice__tables">
    <div class="invoice__tables__expenses" *ngIf="timesheetService.timesheet.commutes.length > 0">
      <p>Détail des indemnités kilométriques :</p>
      <app-expense-mileage-table
      [hideDeleteButton]="true"
      >
      </app-expense-mileage-table>
    </div>

    <div class="invoice__tables__expenses" *ngIf="timesheetService.timesheet.miscellaneous.length > 0">
      <p>Détail des frais sur justificatif :</p>
      <app-expense-miscellaneous-table
      [hideDeleteButton]="true"
      >
      </app-expense-miscellaneous-table>
    </div>

    <div class="invoice__tables__expenses" *ngIf="timesheetService.timesheet.flatFees.length > 0">
      <p>Détail des déplacements forfaitaires :</p>
      <app-expense-flat-fee-table
      [hideDeleteButton]="true"
      >
      </app-expense-flat-fee-table>
    </div>
  </div>
</div>
